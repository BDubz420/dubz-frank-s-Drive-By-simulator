DBS = DBS or {}
DBS.Player = DBS.Player or {}

local function SpawnMoneyDrop(pos, amount)
    if amount <= 0 then return end

    local cash = ents.Create("dbs_money_drop")
    if not IsValid(cash) then return end

    cash:SetPos(pos + Vector(0, 0, 15))
    cash:SetAmount(amount)
    cash:Spawn()
end

function DBS.Player.DropAllVulnerable(ply)
    if not IsValid(ply) then return end

    local money = DBS.Player.GetMoney(ply)
    if money > 0 then
        SpawnMoneyDrop(ply:GetPos(), money)
        DBS.Player.SetMoney(ply, 0)
    end

    for _, wep in ipairs(ply:GetWeapons()) do
        if not IsValid(wep) then continue end

        local class = wep:GetClass()
        if DBS.Config.WeaponDropBlacklist[class] then continue end

        local drop = ents.Create(class)
        if IsValid(drop) then
            drop:SetPos(ply:GetPos() + VectorRand() * 16 + Vector(0, 0, 26))
            drop:SetAngles(AngleRand())
            drop:Spawn()
        end
    end

    ply:StripWeapons()
end

local function EndKnockout(ply)
    if not IsValid(ply) then return end
    if not ply:GetNWBool("DBS_IsKnockedOut", false) then return end

    ply:SetNWBool("DBS_IsKnockedOut", false)
    ply:Freeze(false)

    if not ply:Alive() then return end

    ply:Give("weapon_fists")
    ply:Give("weapon_dbs_hands")
    ply:Give("weapon_dbs_lockpick")
    if ply:GetNWBool("DBS_TrainedPickpocket", false) then
        ply:Give("weapon_dbs_pickpocket")
    end
    ply:SelectWeapon("weapon_dbs_hands")

    DBS.Util.Notify(ply, "You regained consciousness.")
end

hook.Add("EntityTakeDamage", "DBS.KnockoutOnFatal", function(target, dmg)
    if not IsValid(target) or not target:IsPlayer() then return end
    if not target:Alive() then return end
    if target:GetNWBool("DBS_IsKnockedOut", false) then return end

    local attacker = dmg:GetAttacker()
    if not IsValid(attacker) or attacker == target then return end

    local postHealth = target:Health() - dmg:GetDamage()
    if postHealth > 0 then return end

    local cfg = DBS.Config.Vulnerability or {}
    local chance = math.Clamp(cfg.KnockoutChanceOnFatal or 0.5, 0, 1)
    if math.Rand(0, 1) > chance then return end

    dmg:SetDamage(0)

    target:SetHealth(20)
    target:SetNWBool("DBS_IsKnockedOut", true)
    target:Freeze(true)

    DBS.Player.DropAllVulnerable(target)

    local duration = math.max(4, cfg.KnockoutDuration or 15)
    timer.Create("DBS.Knockout." .. target:SteamID64(), duration, 1, function()
        EndKnockout(target)
    end)

    DBS.Util.Notify(target, "You got knocked out and dropped everything.")
end)

hook.Add("PlayerDisconnected", "DBS.KnockoutCleanup", function(ply)
    timer.Remove("DBS.Knockout." .. ply:SteamID64())
end)
