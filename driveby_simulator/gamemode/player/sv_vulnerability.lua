DBS = DBS or {}
DBS.Player = DBS.Player or {}

util.AddNetworkString("DBS_HurtPulse")

local KO_WEAPONS = {
    ["weapon_fists"] = true,
    ["weapon_dbs_hands"] = true,
    ["weapon_stunstick"] = true,
    ["weapon_crowbar"] = true
}

local function SpawnMoneyDrop(pos, amount)
    if amount <= 0 then return end

    local cash = ents.Create("dbs_money_drop")
    if not IsValid(cash) then return end

    cash:SetPos(pos + Vector(0, 0, 15))
    cash:SetAmount(amount)
    cash:Spawn()

    local phys = cash:GetPhysicsObject()
    if IsValid(phys) then
        phys:Wake()
        phys:SetVelocity(Vector(0, 0, 18))
    end
end

function DBS.Player.DropAllVulnerable(ply)
    if not IsValid(ply) then return end

    local money = DBS.Player.GetMoney(ply)
    if money > 0 then
        SpawnMoneyDrop(ply:GetPos(), money)
        DBS.Player.SetMoney(ply, 0)
    end

    for _, wep in ipairs(ply:GetWeapons()) do
        if not IsValid(wep) then continue end

        local class = wep:GetClass()
        if DBS.Config.WeaponDropBlacklist[class] then continue end

        local drop = ents.Create(class)
        if IsValid(drop) then
            local tossPos = ply:EyePos() + ply:GetAimVector() * 16
            drop:SetPos(tossPos)
            drop:SetAngles(Angle(0, ply:EyeAngles().y, 0))
            drop:Spawn()

            local phys = drop:GetPhysicsObject()
            if IsValid(phys) then
                phys:Wake()
                phys:SetVelocity(ply:GetAimVector() * 110 + Vector(0, 0, 20))
            end
        end
    end

    ply:StripWeapons()
end

local function CreateKnockoutRagdoll(ply)
    local rag = ents.Create("prop_ragdoll")
    if not IsValid(rag) then return nil end

    rag:SetModel(ply:GetModel())
    rag:SetPos(ply:GetPos())
    rag:SetAngles(ply:GetAngles())
    rag:Spawn()

    local phys = rag:GetPhysicsObject()
    if IsValid(phys) then
        phys:Wake()
        phys:SetVelocity(ply:GetVelocity())
    end

    return rag
end

local function EndKnockout(ply)
    if not IsValid(ply) then return end
    if not ply:GetNWBool("DBS_IsKnockedOut", false) then return end

    local rag = ply.DBS_KORagdoll
    local wakePos = IsValid(rag) and rag:GetPos() + Vector(0, 0, 20) or ply:GetPos()

    ply:SetNWBool("DBS_IsKnockedOut", false)
    ply:SetNWFloat("DBS_KOEndsAt", 0)

    ply:UnSpectate()
    ply:SetNoDraw(false)
    ply:SetNotSolid(false)
    ply:Freeze(false)
    ply:SetMoveType(MOVETYPE_WALK)
    ply:SetPos(wakePos)

    if IsValid(rag) then rag:Remove() end
    ply.DBS_KORagdoll = nil

    if not ply:Alive() then return end

    ply:Give("weapon_fists")
    ply:Give("weapon_dbs_hands")
    ply:Give("weapon_dbs_lockpick")
    if ply:GetNWBool("DBS_TrainedPickpocket", false) then
        ply:Give("weapon_dbs_pickpocket")
    end
    ply:SelectWeapon("weapon_dbs_hands")

    DBS.Util.Notify(ply, "You wake up groggy and confused.")
end

local function IsKnockoutEligible(target, dmg, attacker)
    if not IsValid(attacker) or not attacker:IsPlayer() then return false end

    local wep = attacker:GetActiveWeapon()
    local class = IsValid(wep) and wep:GetClass() or ""

    local hitgroup = target.DBS_LastHitGroup or HITGROUP_GENERIC
    local blunt = dmg:IsDamageType(DMG_CLUB) or dmg:IsDamageType(DMG_SLASH)
    local meleeWeapon = KO_WEAPONS[class] or false

    if not meleeWeapon and not blunt then
        return false
    end

    return hitgroup == HITGROUP_HEAD or blunt
end

hook.Add("ScalePlayerDamage", "DBS.TrackHitgroupForKO", function(ply, hitgroup)
    ply.DBS_LastHitGroup = hitgroup
end)

hook.Add("EntityTakeDamage", "DBS.HurtPulse", function(target)
    if not IsValid(target) or not target:IsPlayer() then return end
    net.Start("DBS_HurtPulse")
    net.Send(target)
end)

hook.Add("EntityTakeDamage", "DBS.KnockoutOnFatal", function(target, dmg)
    if not IsValid(target) or not target:IsPlayer() then return end
    if not target:Alive() then return end

    if target:GetNWBool("DBS_IsKnockedOut", false) then
        dmg:SetDamage(0)
        return true
    end

    local attacker = dmg:GetAttacker()
    if not IsValid(attacker) or attacker == target then return end

    local postHealth = target:Health() - dmg:GetDamage()
    if postHealth > 0 then return end

    if not IsKnockoutEligible(target, dmg, attacker) then
        return
    end

    local cfg = DBS.Config.Vulnerability or {}
    local chance = math.Clamp(cfg.KnockoutChanceOnFatal or 0.5, 0, 1)
    if math.Rand(0, 1) > chance then return end

    dmg:SetDamage(0)

    local duration = math.max(4, cfg.KnockoutDuration or 15)

    target:SetHealth(20)
    target:SetNWBool("DBS_IsKnockedOut", true)
    target:SetNWFloat("DBS_KOEndsAt", CurTime() + duration)

    DBS.Player.DropAllVulnerable(target)

    local rag = CreateKnockoutRagdoll(target)
    target.DBS_KORagdoll = rag

    target:SetNoDraw(true)
    target:SetNotSolid(true)
    target:SetMoveType(MOVETYPE_NONE)
    target:Freeze(true)
    target:Spectate(OBS_MODE_CHASE)
    if IsValid(rag) then target:SpectateEntity(rag) end

    timer.Create("DBS.Knockout." .. target:SteamID64(), duration, 1, function()
        EndKnockout(target)
    end)

    DBS.Util.Notify(target, "You were knocked out.")
    return true
end)

hook.Add("PlayerDisconnected", "DBS.KnockoutCleanup", function(ply)
    timer.Remove("DBS.Knockout." .. ply:SteamID64())
end)
